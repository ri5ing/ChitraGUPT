/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for most data,
 *              with public read access to auditor profiles. It prioritizes
 *              security and assumes data validation will be handled in the application code.
 *
 * @dataStructure
 *  - /users/{userId}: User profile data, owned by the user.
 *  - /auditors/{auditorId}: Public auditor profiles, readable by all, writable by the auditor themselves.
 *  - /users/{userId}/contracts/{contractId}: Contracts owned by the user.
 *  - /users/{userId}/contracts/{contractId}/analysisReports/{analysisReportId}: AI analysis reports for contracts, owned by the user.
 *  - /users/{userId}/contracts/{contractId}/auditorFeedback/{auditorFeedbackId}: Auditor feedback on contracts, accessible to the contract owner and the auditor.
 *  - /users/{userId}/contracts/{contractId}/annotations/{annotationId}: Annotations on contracts, accessible to the contract owner and the auditor.
 *  - /users/{userId}/contracts/{contractId}/chats/{messageId}: Chat messages for contract reviews.
 *
 * @keySecurityDecisions
 *  - User listing is disallowed to protect privacy.
 *  - Auditor profiles are publicly readable to facilitate auditor discovery.
 *  - All write operations require authentication.
 *  - Data validation is assumed to be handled in the application.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the userId matches their auth.uid.
     * @allow (get, list) - Authenticated user can read their own profile (get) and can list their own documents.
     * @allow (update, delete) - Authenticated user can update or delete their own profile.
     * @deny (create) - User cannot create a profile for another user.
     * @deny (update, delete) - User cannot update or delete another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing users is not permitted
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId) && isExistingOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId) && isExistingOwner(userId);
    }

    /**
     * @description Secure public auditor profiles.
     * @path /auditors/{auditorId}
     * @allow (get, list) - Any authenticated user can read auditor profiles.
     * @allow (create, update, delete) - Only the auditor themselves can create, update, or delete their profile.
     * @deny (create) - User cannot create a profile for another auditor.
     * @deny (update, delete) - User cannot update or delete another auditor's profile.
     * @principle Public read, owner-only writes.
     */
    match /auditors/{auditorId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(auditorId) {
        return request.auth.uid == auditorId;
      }
      function isExistingOwner(auditorId) {
        return isOwner(auditorId) && exists(/databases/$(database)/documents/auditors/$(auditorId));
      }
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(auditorId);
      allow update: if isSignedIn() && isOwner(auditorId) && isExistingOwner(auditorId);
      allow delete: if isSignedIn() && isOwner(auditorId) && isExistingOwner(auditorId);
    }

    /**
     * @description Secure contracts uploaded by users.
     * @path /users/{userId}/contracts/{contractId}
     * @allow (create) - Authenticated user can create a contract under their profile.
     * @allow (get, list) - Authenticated user can read (get) and list contracts under their profile.
     * @allow (update, delete) - Authenticated user can update or delete contracts under their profile.
     * @deny (create) - User cannot create a contract under another user's profile.
     * @deny (update, delete) - User cannot update or delete contracts under another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contracts/{contractId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId, contractId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/contracts/$(contractId));
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId) && isExistingOwner(userId, contractId);
      allow delete: if isSignedIn() && isOwner(userId) && isExistingOwner(userId, contractId);
    }

    /**
     * @description Secure AI analysis reports for contracts.
     * @path /users/{userId}/contracts/{contractId}/analysisReports/{analysisReportId}
     * @allow (create) - Authenticated user can create an AI analysis report under their contract.
     * @allow (get, list) - Authenticated user can read (get) and list AI analysis reports under their contract.
     * @allow (update, delete) - Authenticated user can update or delete AI analysis reports under their contract.
     * @deny (create) - User cannot create an AI analysis report under another user's contract.
     * @deny (update, delete) - User cannot update or delete AI analysis reports under another user's contract.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contracts/{contractId}/analysisReports/{analysisReportId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId, contractId, analysisReportId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/contracts/$(contractId)/analysisReports/$(analysisReportId));
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId) && isExistingOwner(userId, contractId, analysisReportId);
      allow delete: if isSignedIn() && isOwner(userId) && isExistingOwner(userId, contractId, analysisReportId);
    }

    /**
     * @description Secure auditor feedback for contracts.
     * @path /users/{userId}/contracts/{contractId}/auditorFeedback/{auditorFeedbackId}
     * @allow (create) - Authenticated user can create auditor feedback under a contract, only if the user is the contract owner or an auditor.
     * @allow (get, list) - Authenticated user can read (get) and list auditor feedback under a contract, only if the user is the contract owner or an auditor.
     * @allow (update, delete) - Authenticated user can update or delete auditor feedback under a contract, only if the user is the contract owner or the auditor who created the feedback.
     * @deny (create) - User cannot create auditor feedback under another user's contract if they are not the contract owner or an auditor.
     * @deny (update, delete) - User cannot update or delete auditor feedback under another user's contract if they are not the contract owner or the auditor who created the feedback.
     * @principle Enforces document ownership for contract owner and allows auditors to create/update feedback.
     */
    match /users/{userId}/contracts/{contractId}/auditorFeedback/{auditorFeedbackId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isAuditor() {
        return exists(/databases/$(database)/documents/auditors/$(request.auth.uid));
      }
      function isExistingOwner(userId, contractId, auditorFeedbackId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/contracts/$(contractId)/auditorFeedback/$(auditorFeedbackId));
      }
      function isFeedbackOwner(auditorFeedbackId) {
          return request.auth.uid == resource.data.author;
      }
      allow get, list: if isSignedIn() && (isOwner(userId) || isAuditor());
      allow create: if isSignedIn() && (isOwner(userId) || isAuditor());
      allow update: if isSignedIn() && (isOwner(userId) || (isSignedIn() && isFeedbackOwner(auditorFeedbackId)));
      allow delete: if isSignedIn() && (isOwner(userId) || (isSignedIn() && isFeedbackOwner(auditorFeedbackId)));
    }

    /**
     * @description Secure annotations made by auditors on specific contracts.
     * @path /users/{userId}/contracts/{contractId}/annotations/{annotationId}
     * @allow (create) - Authenticated user can create an annotation, only if the user is the contract owner or an auditor.
     * @allow (get, list) - Authenticated user can read (get) and list annotations, only if the user is the contract owner or the auditor who created the annotation.
     * @allow (update, delete) - Authenticated user can update or delete annotations, only if the user is the contract owner or the auditor who created the annotation.
     * @deny (create) - User cannot create an annotation under another user's contract if they are not the contract owner or an auditor.
     * @deny (update, delete) - User cannot update or delete annotations under another user's contract if they are not the contract owner or the auditor who created the annotation.
     * @principle Enforces document ownership for contract owner and allows auditors to create/update annotations.
     */
    match /users/{userId}/contracts/{contractId}/annotations/{annotationId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isAuditor() {
        return exists(/databases/$(database)/documents/auditors/$(request.auth.uid));
      }
      function isExistingOwner(userId, contractId, annotationId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/contracts/$(contractId)/annotations/$(annotationId));
      }
      function isAnnotationOwner(annotationId) {
          return request.auth.uid == resource.data.author;
      }
      allow get, list: if isSignedIn() && (isOwner(userId) || isAuditor());
      allow create: if isSignedIn() && (isOwner(userId) || isAuditor());
      allow update: if isSignedIn() && (isOwner(userId) || (isSignedIn() && isAnnotationOwner(annotationId)));
      allow delete: if isSignedIn() && (isOwner(userId) || (isSignedIn() && isAnnotationOwner(annotationId)));
    }

    /**
     * @description Secure chat messages for contract reviews.
     * @path /users/{userId}/contracts/{contractId}/chats/{messageId}
     * @allow (create) - Authenticated user can create a chat message.
     * @allow (get, list) - Authenticated user can read (get) and list chat messages.
     * @allow (update, delete) - Authenticated user can update or delete chat messages.
     * @deny (create) - User cannot create a chat message.
     * @deny (update, delete) - User cannot update or delete chat messages.
     */
    match /users/{userId}/contracts/{contractId}/chats/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isContractParticipant(userId, contractId) {
          return exists(/databases/$(database)/documents/users/$(userId)/contracts/$(contractId));
      }
      function isExistingOwner(userId, contractId, messageId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/contracts/$(contractId)/chats/$(messageId));
      }
      allow get, list: if isSignedIn() && isContractParticipant(userId, contractId);
      allow create: if isSignedIn() && isContractParticipant(userId, contractId);
      allow update: if isSignedIn() && isOwner(userId) && isExistingOwner(userId, contractId, messageId);
      allow delete: if isSignedIn() && isOwner(userId) && isExistingOwner(userId, contractId, messageId);
    }
  }
}