/**
 * @fileoverview Firestore Security Rules for ChitraGupt application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for private user data,
 * while allowing public read access to auditor profiles.  Write access to
 * auditor profiles is restricted to the profile owner. The rules are designed
 * to prevent unauthorized data access and modification, while enabling
 * necessary public features.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user profile data. Only the user can read/write.
 * - /auditors/{auditorId}: Stores public auditor profile data. Any signed-in user can read.
 * - /users/{userId}/contracts/{contractId}: Stores contracts owned by a specific user.
 * - /users/{userId}/contracts/{contractId}/analysisReports/{analysisReportId}: Stores AI analysis reports for contracts.
 * - /users/{userId}/contracts/{contractId}/auditorFeedback/{auditorFeedbackId}: Stores auditor feedback for contracts.
 * - /users/{userId}/contracts/{contractId}/annotations/{annotationId}: Stores annotations on contracts made by auditors.
 *
 * Key Security Decisions:
 * - User profiles are strictly private; only the owning user can read or write their profile.
 * - Auditor profiles are publicly readable to facilitate the "Recommend Auditor" feature,
 *   but only the auditor can modify their own profile.
 * - Listing users or contracts at the top level is disallowed for privacy reasons.
 * - All subcollections under /users/{userId} inherit the ownership constraint.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {bool} True if the user ID matches the request's auth UID, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Checks if the request is made by the owner of the resource and the resource exists.
      * @param {string} userId The user ID to compare against the request's auth UID.
      * @return {bool} True if the user ID matches the request's auth UID and the resource exists, false otherwise.
      */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User with UID 'test_user' can create their profile if userId matches their UID.
     * @allow (get, update, delete) User with UID 'test_user' can read, update, and delete their profile.
     * @deny (create) User with UID 'test_user' cannot create a profile with a different userId.
     * @deny (get, update, delete) User with UID 'other_user' cannot read, update, or delete the 'test_user' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for auditor profiles.
     * @path /auditors/{auditorId}
     * @allow (get, list) Any signed-in user can read auditor profiles.
     * @allow (create) Auditor with UID 'test_auditor' can create their profile if auditorId matches their UID.
     * @allow (update, delete) Auditor with UID 'test_auditor' can update and delete their own profile.
     * @deny (create) User with UID 'test_user' cannot create an auditor profile.
     * @deny (update, delete) User with UID 'other_user' cannot update or delete the 'test_auditor' profile.
     * @principle Allows public read access but restricts write access to the owner.
     */
    match /auditors/{auditorId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(auditorId) && request.resource.data.id == auditorId;
      allow update: if isExistingOwner(auditorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(auditorId);
    }

    /**
     * @description Rules for contracts.
     * @path /users/{userId}/contracts/{contractId}
     * @allow (create) User with UID 'test_user' can create a contract under their profile.
     * @allow (get, list, update, delete) User with UID 'test_user' can read, list, update, and delete contracts under their profile.
     * @deny (create) User with UID 'other_user' cannot create a contract under 'test_user' profile.
     * @deny (get, list, update, delete) User with UID 'other_user' cannot read, list, update, or delete contracts under 'test_user' profile.
     * @principle Enforces document ownership and hierarchical data access.
     */
    match /users/{userId}/contracts/{contractId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for AI analysis reports.
     * @path /users/{userId}/contracts/{contractId}/analysisReports/{analysisReportId}
     * @allow (create) User with UID 'test_user' can create an analysis report under their contract.
     * @allow (get, list, update, delete) User with UID 'test_user' can read, list, update, and delete analysis reports under their contract.
     * @deny (create) User with UID 'other_user' cannot create an analysis report under 'test_user' profile.
     * @deny (get, list, update, delete) User with UID 'other_user' cannot read, list, update, or delete analysis reports under 'test_user' profile.
     * @principle Enforces document ownership and hierarchical data access.
     */
    match /users/{userId}/contracts/{contractId}/analysisReports/{analysisReportId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for auditor feedback.
     * @path /users/{userId}/contracts/{contractId}/auditorFeedback/{auditorFeedbackId}
     * @allow (create) Auditor with UID 'test_auditor' can create feedback under a contract.
     * @allow (get, list, update, delete) Auditor with UID 'test_auditor' can read, list, update, and delete their feedback.
     * @deny (create) User with UID 'test_user' cannot create feedback under the contract.
     * @deny (get, list, update, delete) User with UID 'test_user' cannot read, list, update, or delete feedback.
     * @principle Restricts feedback access to authorized auditors.
     */
    match /users/{userId}/contracts/{contractId}/auditorFeedback/{auditorFeedbackId} {
      allow get, list: if isSignedIn(); // TODO: Refine to allow only auditors who provided the feedback
      allow create: if isSignedIn(); // TODO: Refine to allow only auditors.  Consider adding an auditorId field to the contract to cross-reference.
      allow update: if isSignedIn() && resource != null; // TODO: Further restrict to the feedback author.
      allow delete: if isSignedIn() && resource != null; // TODO: Further restrict to the feedback author or contract owner.
    }

    /**
     * @description Rules for annotations.
     * @path /users/{userId}/contracts/{contractId}/annotations/{annotationId}
     * @allow (create) Auditor with UID 'test_auditor' can create annotations under a contract.
     * @allow (get, list, update, delete) Auditor with UID 'test_auditor' can read, list, update, and delete their annotations.
     * @deny (create) User with UID 'test_user' cannot create annotations under the contract.
     * @deny (get, list, update, delete) User with UID 'test_user' cannot read, list, update, or delete annotations.
     * @principle Restricts annotation access to authorized auditors.
     */
    match /users/{userId}/contracts/{contractId}/annotations/{annotationId} {
      allow get, list: if isSignedIn(); // TODO: Refine to allow only auditors who created the annotation.
      allow create: if isSignedIn(); // TODO: Refine to allow only auditors.
      allow update: if isSignedIn() && resource != null; // TODO: Further restrict to the annotation author.
      allow delete: if isSignedIn() && resource != null; // TODO: Further restrict to the annotation author or contract owner.
    }
  }
}