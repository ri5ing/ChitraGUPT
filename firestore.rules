/**
 * @file Firestore Security Rules for ChitraGupt Application
 * @core_philosophy This ruleset enforces a strict user-ownership model for most data,
 *                  while allowing public read access to auditor profiles. It prioritizes
 *                  security by default, requiring explicit authorization for all write operations.
 * @data_structure The data is organized hierarchically under /users/{userId}, /auditors/{auditorId} following
 *                 a clear ownership pattern. Contracts, analysis reports, auditor feedback, and
 *                 annotations are nested under the user who owns the contract.
 * @key_security_decisions
 *   - User listing is disabled to prevent unauthorized access to user data.
 *   - Auditor profiles are publicly readable to support the "Recommend Auditor" feature.
 *   - All write operations require authentication and are restricted to the owner of the data,
 *     or in some cases, to an authorized auditor.
 * @denormalization_for_authorization
 *   - Contract documents store the userId to allow simple ownership checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profile information, ensuring only the owner can read or write.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create a profile at /users/user123 if request.auth.uid == 'user123'.
     * @allow (get) User with UID 'user123' can read their profile at /users/user123 if request.auth.uid == 'user123'.
     * @allow (update) User with UID 'user123' can update their profile at /users/user123 if request.auth.uid == 'user123'.
     * @allow (delete) User with UID 'user123' can delete their profile at /users/user123 if request.auth.uid == 'user123'.
     * @deny (create) User with UID 'user456' cannot create a profile at /users/user123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores public-facing auditor profiles. Readable by any signed-in user, writable only by the auditor themselves.
     * @path /auditors/{auditorId}
     * @allow (get) Any signed-in user can read an auditor profile at /auditors/auditor123.
     * @allow (list) Any signed-in user can list auditor profiles.
     * @allow (create) Auditor with UID 'auditor123' can create a profile at /auditors/auditor123 if request.auth.uid == 'auditor123'.
     * @allow (update) Auditor with UID 'auditor123' can update their profile at /auditors/auditor123 if request.auth.uid == 'auditor123'.
     * @allow (delete) Auditor with UID 'auditor123' can delete their profile at /auditors/auditor123 if request.auth.uid == 'auditor123'.
     * @deny (create) User with UID 'user123' cannot create an auditor profile at /auditors/auditor123.
     * @principle Public read, owner-only writes.
     */
    match /auditors/{auditorId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(auditorId) && request.resource.data.id == auditorId;
      allow update: if isExistingOwner(auditorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(auditorId);
    }

    /**
     * @description Secures contracts uploaded by users, ensuring only the owner can read or write.
     * @path /users/{userId}/contracts/{contractId}
     * @allow (create) User with UID 'user123' can create a contract at /users/user123/contracts/contract1 if request.auth.uid == 'user123'.
     * @allow (get) User with UID 'user123' can read their contract at /users/user123/contracts/contract1 if request.auth.uid == 'user123'.
     * @allow (update) User with UID 'user123' can update their contract at /users/user123/contracts/contract1 if request.auth.uid == 'user123'.
     * @allow (delete) User with UID 'user123' can delete their contract at /users/user123/contracts/contract1 if request.auth.uid == 'user123'.
     * @deny (create) User with UID 'user456' cannot create a contract at /users/user123/contracts/contract1.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contracts/{contractId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures AI analysis reports for contracts, ensuring only the owner can read or write.
     * @path /users/{userId}/contracts/{contractId}/analysisReports/{analysisReportId}
     * @allow (create) User with UID 'user123' can create a report at /users/user123/contracts/contract1/analysisReports/report1 if request.auth.uid == 'user123'.
     * @allow (get) User with UID 'user123' can read their report at /users/user123/contracts/contract1/analysisReports/report1 if request.auth.uid == 'user123'.
     * @allow (update) User with UID 'user123' can update their report at /users/user123/contracts/contract1/analysisReports/report1 if request.auth.uid == 'user123'.
     * @allow (delete) User with UID 'user123' can delete their report at /users/user123/contracts/contract1/analysisReports/report1 if request.auth.uid == 'user123'.
     * @deny (create) User with UID 'user456' cannot create a report at /users/user123/contracts/contract1/analysisReports/report1.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contracts/{contractId}/analysisReports/{analysisReportId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures auditor feedback for contracts, ensuring only authorized auditors can add, read, update or delete feedback.
     * @path /users/{userId}/contracts/{contractId}/auditorFeedback/{auditorFeedbackId}
     * @allow (create) Any auditor can add feedback to the contract.
     * @allow (get) Owner can read feedback on their contract
     * @allow (update) Only the auditor that created the feedback can update it.
     * @allow (delete) Only the auditor that created the feedback can delete it.
     * @deny (create) User with UID 'user456' cannot create feedback at /users/user123/contracts/contract1/auditorFeedback/feedback1 if not an auditor.
     */
    match /users/{userId}/contracts/{contractId}/auditorFeedback/{auditorFeedbackId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn(); // Any signed-in user can create feedback (assuming auditor role is verified elsewhere).
      allow update: if isSignedIn() && resource.data.auditorId == request.auth.uid && resource != null;
      allow delete: if isSignedIn() && resource.data.auditorId == request.auth.uid && resource != null;
    }

    /**
     * @description Secures annotations made by auditors on contracts, ensuring only authorized auditors can add, read, update or delete annotations.
     * @path /users/{userId}/contracts/{contractId}/annotations/{annotationId}
     * @allow (create) Any auditor can add annotations to the contract.
     * @allow (get) Owner can read annotations on their contract
     * @allow (update) Only the auditor that created the annotations can update it.
     * @allow (delete) Only the auditor that created the annotations can delete it.
     * @deny (create) User with UID 'user456' cannot create annotation at /users/user123/contracts/contract1/annotations/annotation1 if not an auditor.
     */
    match /users/{userId}/contracts/{contractId}/annotations/{annotationId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn(); // Any signed-in user can create annotation (assuming auditor role is verified elsewhere).
      allow update: if isSignedIn() && resource.data.auditorId == request.auth.uid && resource != null;
      allow delete: if isSignedIn() && resource.data.auditorId == request.auth.uid && resource != null;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}